<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ImobiSystem Pro - Sistema Imobili√°rio</title>
    <meta name="description" content="Sistema completo de gest√£o imobili√°ria com WhatsApp integrado">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #1a1f2e;
            --primary-light: #2a3142;
            --accent: #c29958;
            --accent-light: #d4af77;
            --text-primary: #1a1f2e;
            --text-secondary: #64748b;
            --bg-light: #f8f9fa;
            --border-color: #e2e8f0;
            --shadow: rgba(26, 31, 46, 0.08);
        }
        
        * { 
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            letter-spacing: -0.01em;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', Georgia, 'Times New Roman', serif;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            input, select, textarea, button {
                font-size: 16px !important;
            }
            
            .auth-container {
                padding: 1.5rem !important;
                margin: 1rem;
            }
            
            .status-banner {
                font-size: 0.75rem;
                padding: 8px 12px;
            }
            
            .card {
                margin-bottom: 12px;
            }
            
            h1 {
                font-size: 1.5rem !important;
            }
            
            h2 {
                font-size: 1.25rem !important;
            }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeInUp { 
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        .hidden { 
            display: none !important; 
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,.2);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s ease infinite;
        }
        
        .status-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 500;
            font-size: 0.813rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            border-bottom: 1px solid var(--accent);
        }
        
        .status-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px var(--shadow);
        }
        
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-light);
            border-color: var(--primary);
        }
        
        .btn-accent {
            background: var(--accent);
            color: white;
            border: 1px solid var(--accent);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-accent:hover:not(:disabled) {
            background: var(--accent-light);
            transform: translateY(-1px);
        }
        
        .input-field {
            background: white;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 31, 46, 0.05);
        }
        
        .card {
            background: white;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        
        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 20px 40px -15px var(--shadow);
            transform: translateY(-2px);
        }
        
        /* Galeria de Fotos */
        .photo-gallery {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .gallery-image.active {
            display: block;
        }
        
        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .gallery-nav:hover {
            background: rgba(0,0,0,0.8);
            transform: translateY(-50%) scale(1.1);
        }
        
        .gallery-nav-prev {
            left: 10px;
        }
        
        .gallery-nav-next {
            right: 10px;
        }
        
        .gallery-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .gallery-thumbnails {
            display: flex;
            gap: 8px;
            padding: 8px;
            overflow-x: auto;
        }
        
        .gallery-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .gallery-thumb.active {
            opacity: 1;
            border: 2px solid var(--accent);
        }
        
        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .lightbox.active {
            display: flex;
        }
        
        .lightbox-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .lightbox-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        /* Perfil do Corretor */
        .seller-profile {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .seller-header {
            display: flex;
            gap: 20px;
            align-items: start;
            margin-bottom: 20px;
        }
        
        .seller-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent);
        }
        
        .seller-photo-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
        }
        
        .seller-info {
            flex: 1;
        }
        
        .seller-name {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .seller-region {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }
        
        .seller-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        
        .stars {
            display: flex;
            gap: 2px;
        }
        
        .star {
            color: #fbbf24;
            font-size: 18px;
        }
        
        .star.empty {
            color: #e5e7eb;
        }
        
        .rating-count {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .seller-bio {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .seller-stats {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        
        .property-type-badge {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 5;
        }
        
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
        }
        
        .accent-line {
            width: 60px;
            height: 3px;
            background: var(--accent);
            margin: 0 auto;
        }
        
        .professional-gradient {
            background: linear-gradient(135deg, #1a1f2e 0%, #2a3142 50%, #1a1f2e 100%);
        }
        
        .auth-container {
            background: white;
            border: 1px solid var(--border-color);
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.15);
        }
        
        .modal-backdrop {
            backdrop-filter: blur(8px);
            background: rgba(26, 31, 46, 0.4);
        }
        
        .property-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .premium-accent {
            color: var(--accent);
            font-weight: 600;
        }
        
        .section-header {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .preference-tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .preference-tag:hover {
            border-color: var(--primary);
            background: white;
        }

        .preference-tag.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .recovery-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .password-toggle:hover {
            color: var(--primary);
        }

        .password-input-wrapper {
            position: relative;
            width: 100%;
        }

        /* Mobile optimizations */
        @media (max-width: 640px) {
            .status-banner {
                font-size: 0.75rem;
                padding: 8px 12px;
            }

            .auth-container {
                padding: 1.5rem !important;
            }

            input, select, textarea, button {
                font-size: 16px !important; /* Previne zoom no iOS */
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <div class="status-banner">
        <span class="status-indicator"></span>
        <span style="color: var(--accent); font-weight: 600;">Sistema Ativo</span>
        <span class="mx-2">‚Ä¢</span>
        Firestore Database
    </div>

    <!-- DEBUG VISUAL -->
    <div id="debug-panel" class="fixed bottom-0 left-0 right-0 bg-black text-white p-2 text-xs font-mono overflow-y-auto z-50" style="max-height: 150px; font-size: 10px;">
        <div class="flex justify-between items-center mb-1">
            <strong>üìä DEBUG LOG:</strong>
            <button onclick="document.getElementById('debug-panel').classList.add('hidden')" class="text-red-400 font-bold">‚úñ</button>
        </div>
        <div id="debug-log"></div>
    </div>

    <!-- BOT√ÉO DE EMERG√äNCIA (s√≥ aparece se travar) -->
    <div id="emergency-reset" class="hidden fixed bottom-4 right-4 z-50">
        <button onclick="forceReset()" 
            class="px-6 py-3 rounded-lg font-semibold text-sm shadow-2xl"
            style="background: #ef4444; color: white; border: 2px solid #dc2626;">
            üîÑ Resetar Login
        </button>
    </div>

    <!-- RECOVERY MODAL -->
    <div id="recovery-modal" class="recovery-modal hidden">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4" style="border: 1px solid var(--border-color);">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">Dados Incompletos</h3>
                <p class="text-sm mb-4" style="color: var(--text-secondary);">
                    Complete as informa√ß√µes para continuar
                </p>
            </div>

            <form id="recovery-form" class="space-y-4">
                <div>
                    <label class="section-header">Nome Completo *</label>
                    <input type="text" id="recovery-name" placeholder="Seu nome" required
                        class="input-field w-full px-4 py-3 rounded-md text-sm" />
                </div>

                <div>
                    <label class="section-header">Tipo de Perfil *</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative cursor-pointer">
                            <input type="radio" name="recovery-type" value="buyer" checked class="peer sr-only">
                            <div class="input-field peer-checked:border-primary peer-checked:bg-gray-50 p-3 rounded-md text-center">
                                <div class="text-sm font-semibold">Comprador</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="recovery-type" value="seller" class="peer sr-only">
                            <div class="input-field peer-checked:border-primary peer-checked:bg-gray-50 p-3 rounded-md text-center">
                                <div class="text-sm font-semibold">Vendedor</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="recovery-seller-fields" class="hidden space-y-4">
                    <div>
                        <label class="section-header">Telefone *</label>
                        <input type="text" id="recovery-phone" placeholder="(11) 98765-4321"
                            oninput="formatPhoneInput(this)" maxlength="15"
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                    <div>
                        <label class="section-header">CRECI *</label>
                        <input type="text" id="recovery-creci" placeholder="F-12345"
                            oninput="formatCRECIInput(this)" maxlength="10"
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                </div>

                <button type="submit" id="recovery-btn" class="btn-primary w-full py-3 rounded-md font-semibold text-sm">
                    <span id="recovery-btn-text">Salvar e Continuar</span>
                </button>
            </form>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="min-h-screen professional-gradient flex items-center justify-center p-4 md:p-8" style="margin-top: 40px;">
        <div class="max-w-md w-full">
            <div class="text-center mb-10 animate-fadeInUp">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-lg shadow-xl mb-6" style="border: 1px solid var(--border-color);">
                    <svg class="w-10 h-10" style="color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                </div>
                <h1 class="text-4xl font-bold text-white mb-3">ImobiSystem Pro</h1>
                <div class="accent-line mb-4"></div>
                <p class="text-gray-300 font-light tracking-wide">Plataforma Corporativa de Gest√£o Imobili√°ria</p>
            </div>

            <!-- LOGIN FORM -->
            <div id="login-form" class="auth-container rounded-lg p-8 animate-fadeInUp">
                <h2 class="text-2xl font-semibold mb-2" style="color: var(--text-primary);">Acesso √† Plataforma</h2>
                <p class="text-sm mb-8" style="color: var(--text-secondary);">Insira suas credenciais</p>

                <form id="form-login" class="space-y-5">
                    <div>
                        <label class="section-header">Email</label>
                        <input type="email" id="login-email" placeholder="usuario@empresa.com.br" required
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                    
                    <div>
                        <label class="section-header">Senha</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6"
                                class="input-field w-full px-4 py-3 rounded-md text-sm pr-12" />
                            <span class="password-toggle" onclick="togglePassword('login-password')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </span>
                        </div>
                    </div>
                    
                    <button type="submit" id="login-btn"
                        class="btn-primary w-full py-3 rounded-md font-semibold text-sm flex items-center justify-center gap-2">
                        <span id="login-btn-text">Acessar Sistema</span>
                        <div id="login-btn-loader" class="loader hidden"></div>
                    </button>
                </form>

                <div class="divider my-8"></div>

                <div class="text-center">
                    <p class="text-sm" style="color: var(--text-secondary);">
                        N√£o possui cadastro?
                        <button type="button" onclick="showRegisterForm()" class="premium-accent hover:underline ml-1 font-semibold">
                            Criar Conta
                        </button>
                    </p>
                </div>
            </div>

            <!-- REGISTER FORM -->
            <div id="register-form" class="auth-container rounded-lg p-8 animate-fadeInUp hidden">
                <h2 class="text-2xl font-semibold mb-2" style="color: var(--text-primary);">Cadastro</h2>
                <p class="text-sm mb-8" style="color: var(--text-secondary);">Crie sua conta</p>

                <form id="form-register" class="space-y-5">
                    <div>
                        <label class="section-header">Nome Completo *</label>
                        <input type="text" id="register-name" placeholder="Nome e sobrenome" required minlength="3"
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                    
                    <div>
                        <label class="section-header">Email *</label>
                        <input type="email" id="register-email" placeholder="usuario@empresa.com.br" required
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                    
                    <div>
                        <label class="section-header">Perfil *</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="user-type" value="buyer" checked class="peer sr-only" onchange="toggleUserTypeFields()">
                                <div class="input-field peer-checked:border-primary peer-checked:bg-gray-50 p-4 rounded-md text-center transition-all">
                                    <div class="text-sm font-semibold" style="color: var(--text-primary);">Comprador</div>
                                    <div class="text-xs mt-1" style="color: var(--text-secondary);">Buscar</div>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="user-type" value="seller" class="peer sr-only" onchange="toggleUserTypeFields()">
                                <div class="input-field peer-checked:border-primary peer-checked:bg-gray-50 p-4 rounded-md text-center transition-all">
                                    <div class="text-sm font-semibold" style="color: var(--text-primary);">Vendedor</div>
                                    <div class="text-xs mt-1" style="color: var(--text-secondary);">Anunciar</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div id="seller-fields" class="hidden space-y-5">
                        <div>
                            <label class="section-header">Telefone *</label>
                            <input type="text" id="register-phone" placeholder="(11) 98765-4321" 
                                   oninput="formatPhoneInput(this)" maxlength="15"
                                   class="input-field w-full px-4 py-3 rounded-md text-sm" />
                        </div>
                        <div>
                            <label class="section-header">CRECI *</label>
                            <input type="text" id="register-creci" placeholder="F-12345"
                                   oninput="formatCRECIInput(this)" maxlength="10"
                                   class="input-field w-full px-4 py-3 rounded-md text-sm" />
                        </div>
                        <div>
                            <label class="section-header">Foto de Perfil (URL)</label>
                            <input type="url" id="register-photo" placeholder="https://exemplo.com/foto.jpg"
                                   class="input-field w-full px-4 py-3 rounded-md text-sm" />
                            <p class="text-xs text-gray-500 mt-1">Cole a URL de uma foto sua (opcional)</p>
                        </div>
                        <div>
                            <label class="section-header">Regi√£o de Atua√ß√£o</label>
                            <input type="text" id="register-region" placeholder="Ex: Zona Sul - S√£o Paulo"
                                   class="input-field w-full px-4 py-3 rounded-md text-sm" />
                        </div>
                    </div>
                    
                    <div>
                        <label class="section-header">Biografia Profissional</label>
                        <textarea id="register-bio" placeholder="Conte um pouco sobre sua experi√™ncia como corretor..."
                                  maxlength="500" rows="4"
                                  class="input-field w-full px-4 py-3 rounded-md text-sm resize-none"></textarea>
                        <p class="text-xs text-gray-500 mt-1"><span id="bio-counter">0</span>/500 caracteres</p>
                    </div>

                    <div>
                        <label class="section-header">Senha *</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="register-password" placeholder="M√≠nimo 6 caracteres" required minlength="6"
                                class="input-field w-full px-4 py-3 rounded-md text-sm pr-12" />
                            <span class="password-toggle" onclick="togglePassword('register-password')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="section-header">Confirmar Senha *</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="register-confirm-password" placeholder="Digite novamente" required minlength="6"
                                class="input-field w-full px-4 py-3 rounded-md text-sm pr-12" />
                            <span class="password-toggle" onclick="togglePassword('register-confirm-password')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </span>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="submit" id="register-btn"
                            class="btn-primary flex-1 py-3 rounded-md font-semibold text-sm flex items-center justify-center gap-2">
                            <span id="register-btn-text">Criar Conta</span>
                            <div id="register-btn-loader" class="loader hidden"></div>
                        </button>
                        <button type="button" onclick="showLoginForm()"
                            class="btn-secondary px-6 py-3 rounded-md font-semibold text-sm">
                            Login
                        </button>
                    </div>
                </form>

                <div class="divider my-8"></div>

                <div class="text-center">
                    <p class="text-sm" style="color: var(--text-secondary);">
                        J√° tem conta?
                        <button type="button" onclick="showLoginForm()" class="premium-accent hover:underline ml-1 font-semibold">Login</button>
                    </p>
                </div>
            </div>

            <p class="text-center text-gray-400 text-xs mt-8">
                ¬© 2026 ImobiSystem Pro
            </p>
        </div>
    </div>

    <!-- BUYER PROFILE SCREEN -->
    <div id="buyer-profile-screen" class="hidden min-h-screen professional-gradient flex items-center justify-center p-4 md:p-8" style="margin-top: 40px;">
        <div class="max-w-2xl w-full">
            <div class="text-center mb-8 animate-fadeInUp">
                <h1 class="text-3xl font-bold text-white mb-3">Complete seu Perfil</h1>
                <div class="accent-line mb-4"></div>
                <p class="text-gray-300 font-light">Personalize suas prefer√™ncias</p>
            </div>

            <div class="auth-container rounded-lg p-8 animate-fadeInUp">
                <form id="form-buyer-profile" class="space-y-6">
                    <div>
                        <label class="section-header">Tipo de Im√≥vel</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="preference-tag" onclick="togglePreference(this, 'propertyTypes', 'Apartamento')">Apartamento</button>
                            <button type="button" class="preference-tag" onclick="togglePreference(this, 'propertyTypes', 'Casa')">Casa</button>
                            <button type="button" class="preference-tag" onclick="togglePreference(this, 'propertyTypes', 'Studio')">Studio</button>
                            <button type="button" class="preference-tag" onclick="togglePreference(this, 'propertyTypes', 'Cobertura')">Cobertura</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="section-header">Pre√ßo M√≠nimo (R$)</label>
                            <input type="number" id="profile-min-price" placeholder="200000" min="0" step="1000"
                                class="input-field w-full px-4 py-3 rounded-md text-sm" />
                        </div>
                        <div>
                            <label class="section-header">Pre√ßo M√°ximo (R$)</label>
                            <input type="number" id="profile-max-price" placeholder="500000" min="0" step="1000"
                                class="input-field w-full px-4 py-3 rounded-md text-sm" />
                        </div>
                    </div>

                    <div>
                        <label class="section-header">Bairros</label>
                        <input type="text" id="profile-neighborhoods" placeholder="Jardins, Pinheiros (separados por v√≠rgula)"
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="section-header">Quartos</label>
                            <select id="profile-min-rooms" class="input-field w-full px-4 py-3 rounded-md text-sm">
                                <option value="">Qualquer</option>
                                <option value="1">1+</option>
                                <option value="2">2+</option>
                                <option value="3">3+</option>
                                <option value="4">4+</option>
                            </select>
                        </div>
                        <div>
                            <label class="section-header">Vagas</label>
                            <select id="profile-min-parking" class="input-field w-full px-4 py-3 rounded-md text-sm">
                                <option value="">Qualquer</option>
                                <option value="1">1+</option>
                                <option value="2">2+</option>
                                <option value="3">3+</option>
                            </select>
                        </div>
                        <div>
                            <label class="section-header">√Årea m√≠n</label>
                            <input type="number" id="profile-min-size" placeholder="50" min="0" step="1"
                                class="input-field w-full px-4 py-3 rounded-md text-sm" />
                        </div>
                        <div>
                            <label class="section-header">√Årea m√°x</label>
                            <input type="number" id="profile-max-size" placeholder="200" min="0" step="1"
                                class="input-field w-full px-4 py-3 rounded-md text-sm" />
                        </div>
                    </div>

                    <div>
                        <label class="section-header">Observa√ß√µes</label>
                        <textarea id="profile-notes" placeholder="Prefer√™ncias adicionais" rows="3"
                            class="input-field w-full px-4 py-3 rounded-md text-sm resize-none"></textarea>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="submit" id="profile-save-btn"
                            class="btn-accent flex-1 px-6 py-3 rounded-md font-semibold text-sm flex items-center justify-center gap-2">
                            <span id="profile-save-text">Salvar e Continuar</span>
                            <div id="profile-save-loader" class="loader hidden"></div>
                        </button>
                        <button type="button" onclick="skipBuyerProfile()"
                            class="btn-secondary px-6 py-3 rounded-md font-semibold text-sm">
                            Pular
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden min-h-screen" style="margin-top: 40px;">
        <header class="bg-white border-b" style="border-color: var(--border-color);">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 flex items-center justify-center rounded-lg" style="background: var(--primary);">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-semibold" style="color: var(--text-primary);">ImobiSystem</h1>
                            <p class="text-xs" style="color: var(--text-secondary);">Plataforma Imobili√°ria</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <span id="user-name-header" class="text-sm font-semibold block" style="color: var(--text-primary);"></span>
                            <span id="user-type-badge" class="text-xs" style="color: var(--text-secondary);"></span>
                        </div>
                        <button type="button" id="buyer-edit-profile-btn" onclick="editBuyerProfile()" class="hidden btn-secondary px-4 py-2 rounded-md text-sm font-medium">
                            Editar
                        </button>
                        <button type="button" onclick="handleLogout()"
                            class="px-4 py-2 rounded-md text-sm font-medium"
                            style="background: var(--bg-light); color: var(--text-secondary); border: 1px solid var(--border-color);">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="seller-controls" class="mb-8 hidden">
                <button type="button" onclick="showPropertyModal()"
                    class="btn-accent px-6 py-3 rounded-md font-semibold text-sm flex items-center gap-3 shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Cadastrar Im√≥vel
                </button>
            </div>

            <!-- Buyer Profile Summary -->
            <div id="buyer-profile-summary" class="hidden card rounded-lg p-6 mb-8">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-1" style="color: var(--text-primary);">Suas Prefer√™ncias</h3>
                        <p class="text-sm" style="color: var(--text-secondary);">Filtrado por seu perfil</p>
                    </div>
                    <button type="button" onclick="editBuyerProfile()" class="text-sm premium-accent hover:underline font-semibold">
                        Editar
                    </button>
                </div>
                <div id="profile-summary-content" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="card rounded-lg p-6 mb-8">
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="flex-1 relative">
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <input type="text" id="search-input" placeholder="Buscar..." onkeyup="applyFilters()"
                            class="input-field w-full pl-12 pr-4 py-3 rounded-md text-sm" />
                    </div>
                    
                    <button type="button" onclick="toggleFilters()"
                        class="btn-secondary px-6 py-3 rounded-md font-medium text-sm">
                        Filtros
                    </button>
                    
                    <button type="button" onclick="clearFilters()"
                        class="btn-secondary px-4 py-2 rounded-md font-medium text-sm">
                        Limpar
                    </button>
                </div>

                <div id="advanced-filters" class="hidden mt-6 pt-6 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4" style="border-top: 1px solid var(--border-color);">
                    <select id="filter-type" onchange="applyFilters()" class="input-field px-4 py-3 rounded-md text-sm">
                        <option value="">Todos</option>
                        <option value="Apartamento">Apartamento</option>
                        <option value="Casa">Casa</option>
                        <option value="Studio">Studio</option>
                        <option value="Cobertura">Cobertura</option>
                    </select>

                    <input type="text" id="filter-neighborhood" placeholder="Bairro" onkeyup="applyFilters()"
                        class="input-field px-4 py-3 rounded-md text-sm" />

                    <input type="number" id="filter-min-price" placeholder="Pre√ßo m√≠n" onchange="applyFilters()"
                        class="input-field px-4 py-3 rounded-md text-sm" />

                    <input type="number" id="filter-max-price" placeholder="Pre√ßo m√°x" onchange="applyFilters()"
                        class="input-field px-4 py-3 rounded-md text-sm" />
                </div>

                <div class="text-sm font-medium mb-6 mt-4" style="color: var(--text-secondary);">
                    <span id="results-count">Carregando...</span>
                </div>
            </div>

            <div id="loading-state" class="card rounded-lg p-16 text-center">
                <div class="loader mx-auto mb-4" style="width: 40px; height: 40px; border-width: 3px; border-color: var(--border-color); border-top-color: var(--primary);"></div>
                <h3 class="text-lg font-semibold mb-2" style="color: var(--text-primary);">Carregando</h3>
                <p class="text-sm" style="color: var(--text-secondary);">Sincronizando...</p>
            </div>

            <div id="properties-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

            <div id="empty-state" class="hidden card rounded-lg p-16 text-center">
                <svg class="w-16 h-16 mx-auto mb-4" style="color: var(--border-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <h3 class="text-lg font-semibold mb-2" style="color: var(--text-primary);">Nenhum Im√≥vel</h3>
                <p class="text-sm" style="color: var(--text-secondary);">Ajuste os filtros</p>
            </div>
        </div>
    </div>

    <!-- PROPERTY MODAL -->
    <div id="property-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full my-8" style="border: 1px solid var(--border-color);">
            <div class="px-8 py-6" style="background: var(--primary); border-radius: 0.5rem 0.5rem 0 0;">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-2xl font-semibold text-white mb-1">Cadastrar Im√≥vel</h3>
                        <p class="text-sm text-gray-300">Preencha os dados</p>
                    </div>
                    <button type="button" onclick="closePropertyModal()" class="text-gray-300 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <form id="form-property" class="p-8 space-y-6 max-h-[70vh] overflow-y-auto">
                <div>
                    <label class="section-header">Nome *</label>
                    <input type="text" id="property-name" placeholder="Residencial Jardim das Flores" required
                        class="input-field w-full px-4 py-3 rounded-md text-sm" />
                </div>

                <div>
                    <label class="section-header">Construtora *</label>
                    <input type="text" id="property-builder" placeholder="Construtora Prime" required
                        class="input-field w-full px-4 py-3 rounded-md text-sm" />
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="section-header">Logradouro *</label>
                        <input type="text" id="property-street" placeholder="Rua e n√∫mero" required
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                    <div>
                        <label class="section-header">Bairro *</label>
                        <input type="text" id="property-neighborhood" placeholder="Nome do bairro" required
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                </div>

                <div>
                    <label class="section-header">Tipo *</label>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <button type="button" onclick="selectPropertyType('Apartamento')" data-type="Apartamento" 
                            class="property-type-btn input-field px-4 py-3 rounded-md font-medium text-sm">
                            Apartamento
                        </button>
                        <button type="button" onclick="selectPropertyType('Casa')" data-type="Casa" 
                            class="property-type-btn input-field px-4 py-3 rounded-md font-medium text-sm">
                            Casa
                        </button>
                        <button type="button" onclick="selectPropertyType('Studio')" data-type="Studio" 
                            class="property-type-btn input-field px-4 py-3 rounded-md font-medium text-sm">
                            Studio
                        </button>
                        <button type="button" onclick="selectPropertyType('Cobertura')" data-type="Cobertura" 
                            class="property-type-btn input-field px-4 py-3 rounded-md font-medium text-sm">
                            Cobertura
                        </button>
                    </div>
                    <input type="hidden" id="property-type" required>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div>
                        <label class="section-header">√Årea (m¬≤) *</label>
                        <input type="number" id="property-size" placeholder="0" required min="1" step="0.01"
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                    <div>
                        <label class="section-header">Quartos *</label>
                        <input type="number" id="property-rooms" placeholder="0" required min="0"
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                    <div>
                        <label class="section-header">Vagas *</label>
                        <input type="number" id="property-parking" placeholder="0" required min="0"
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                    <div>
                        <label class="section-header">Valor (R$) *</label>
                        <input type="number" id="property-price" placeholder="0" required min="1" step="0.01"
                            class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    </div>
                </div>

                <div>
                    <label class="section-header">Fotos do Im√≥vel (at√© 5)</label>
                    <input type="url" id="property-photo-1" placeholder="https://exemplo.com/foto1.jpg"
                        class="input-field w-full px-4 py-3 rounded-md text-sm mb-2" />
                    <input type="url" id="property-photo-2" placeholder="https://exemplo.com/foto2.jpg (opcional)"
                        class="input-field w-full px-4 py-3 rounded-md text-sm mb-2" />
                    <input type="url" id="property-photo-3" placeholder="https://exemplo.com/foto3.jpg (opcional)"
                        class="input-field w-full px-4 py-3 rounded-md text-sm mb-2" />
                    <input type="url" id="property-photo-4" placeholder="https://exemplo.com/foto4.jpg (opcional)"
                        class="input-field w-full px-4 py-3 rounded-md text-sm mb-2" />
                    <input type="url" id="property-photo-5" placeholder="https://exemplo.com/foto5.jpg (opcional)"
                        class="input-field w-full px-4 py-3 rounded-md text-sm" />
                    <p class="text-xs text-gray-500 mt-1">Cole as URLs das fotos (m√≠nimo 1, m√°ximo 5)</p>
                </div>

                <div>
                    <label class="section-header">Descri√ß√£o *</label>
                    <textarea id="property-description" placeholder="Descreva as caracter√≠sticas..." required rows="4"
                        class="input-field w-full px-4 py-3 rounded-md text-sm resize-none"></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="submit" id="save-property-btn"
                        class="btn-accent flex-1 px-6 py-3 rounded-md font-semibold text-sm flex items-center justify-center gap-2">
                        <span id="save-btn-text">Cadastrar</span>
                        <div id="save-btn-loader" class="loader hidden"></div>
                    </button>
                    <button type="button" onclick="closePropertyModal()"
                        class="btn-secondary px-6 py-3 rounded-md font-semibold text-sm">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- CONTACT MODAL -->
    <div id="contact-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full" style="border: 1px solid var(--border-color);">
            <div class="px-6 py-5" style="background: var(--primary); border-radius: 0.5rem 0.5rem 0 0;">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-white">Contato</h3>
                    <button type="button" onclick="closeContactModal()" class="text-gray-300 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="p-6 space-y-6">
                <div class="p-4 rounded-md" style="background: var(--bg-light); border: 1px solid var(--border-color);">
                    <h4 id="contact-property-name" class="font-semibold text-base mb-1" style="color: var(--text-primary);"></h4>
                    <p id="contact-property-builder" class="text-sm font-medium mb-1" style="color: var(--text-secondary);"></p>
                    <p id="contact-property-address" class="text-sm mb-3" style="color: var(--text-secondary);"></p>
                    <p id="contact-property-price" class="text-2xl font-bold premium-accent"></p>
                </div>

                <div>
                    <label class="section-header">Corretor</label>
                    <p id="contact-seller-name" class="text-base font-semibold" style="color: var(--text-primary);"></p>
                </div>

                <div>
                    <label class="section-header">CRECI</label>
                    <p id="contact-seller-creci" class="text-base font-semibold" style="color: var(--text-primary);"></p>
                </div>

                <div>
                    <label class="section-header">Telefone</label>
                    <div class="flex gap-2">
                        <input type="text" id="contact-seller-phone" readonly
                            class="input-field flex-1 px-4 py-3 rounded-md text-base font-semibold" style="background: var(--bg-light);" />
                        <button type="button" onclick="copyPhone()" title="Copiar"
                            class="btn-primary px-4 py-3 rounded-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="button" onclick="openWhatsApp()" 
                    class="w-full py-3 rounded-md font-semibold text-sm flex items-center justify-center gap-2"
                    style="background: #25D366; color: white; border: 1px solid #25D366;">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    Abrir no WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- UI Functions -->
    <script>
        let selectedPreferences = {
            propertyTypes: []
        };

        let currentRecoveryUser = null;
        let currentWhatsAppNumber = '';
        let currentPropertyName = '';

        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        function forceReset() {
            debugLog('üîÑ RESET FOR√áADO');
            sessionStorage.clear();
            localStorage.clear();
            location.reload();
        }

        // FUN√á√ÉO DE DEBUG VISUAL
        function debugLog(message) {
            console.log(message);
            const debugDiv = document.getElementById('debug-log');
            if (debugDiv) {
                const time = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `<div>[${time}] ${message}</div>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        function toggleUserTypeFields() {
            const userType = document.querySelector('input[name="user-type"]:checked').value;
            const sellerFields = document.getElementById('seller-fields');
            const phoneInput = document.getElementById('register-phone');
            const creciInput = document.getElementById('register-creci');
            
            if (userType === 'seller') {
                sellerFields.classList.remove('hidden');
                phoneInput.required = true;
                creciInput.required = true;
            } else {
                sellerFields.classList.add('hidden');
                phoneInput.required = false;
                creciInput.required = false;
            }
        }

        // Recovery type toggle
        document.addEventListener('DOMContentLoaded', () => {
            const recoveryTypeInputs = document.querySelectorAll('input[name="recovery-type"]');
            recoveryTypeInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    const sellerFields = document.getElementById('recovery-seller-fields');
                    if (e.target.value === 'seller') {
                        sellerFields.classList.remove('hidden');
                    } else {
                        sellerFields.classList.add('hidden');
                    }
                });
            });
        });

        function formatPhoneInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length <= 10) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else {
                value = value.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
            }
            input.value = value;
        }

        function formatCRECIInput(input) {
            let value = input.value.toUpperCase().replace(/[^FJ0-9-]/g, '');
            if (value.length > 0 && !value.match(/^[FJ]/)) value = '';
            if (value.length > 1 && !value.includes('-')) {
                value = value.charAt(0) + '-' + value.slice(1);
            }
            input.value = value;
        }

        function formatPhone(phone) {
            if (!phone) return '';
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 11) {
                return `(${cleaned.slice(0, 2)}) ${cleaned.slice(2, 7)}-${cleaned.slice(7)}`;
            } else if (cleaned.length === 10) {
                return `(${cleaned.slice(0, 2)}) ${cleaned.slice(2, 6)}-${cleaned.slice(6)}`;
            }
            return phone;
        }

        function togglePreference(button, category, value) {
            button.classList.toggle('selected');
            
            if (!selectedPreferences[category]) {
                selectedPreferences[category] = [];
            }
            
            const index = selectedPreferences[category].indexOf(value);
            if (index > -1) {
                selectedPreferences[category].splice(index, 1);
            } else {
                selectedPreferences[category].push(value);
            }
        }

        function skipBuyerProfile() {
            if (window.firebaseApp && window.firebaseApp.showMainApp && window.firebaseApp.currentUser) {
                window.firebaseApp.showMainApp(window.firebaseApp.currentUser);
            }
        }

        function editBuyerProfile() {
            if (window.firebaseApp && window.firebaseApp.showBuyerProfileScreen) {
                window.firebaseApp.showBuyerProfileScreen(true);
            }
        }

        function showPropertyModal() {
            document.getElementById('property-modal').classList.remove('hidden');
            document.querySelectorAll('.property-type-btn').forEach(btn => {
                btn.style.borderColor = 'var(--border-color)';
                btn.style.background = 'white';
            });
        }

        function closePropertyModal() {
            document.getElementById('property-modal').classList.add('hidden');
            document.getElementById('form-property').reset();
            document.getElementById('property-type').value = '';
        }

        function selectPropertyType(type) {
            document.getElementById('property-type').value = type;
            
            document.querySelectorAll('.property-type-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.style.borderColor = 'var(--primary)';
                    btn.style.background = 'var(--bg-light)';
                } else {
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.background = 'white';
                }
            });
        }

        function toggleFilters() {
            document.getElementById('advanced-filters').classList.toggle('hidden');
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-neighborhood').value = '';
            document.getElementById('filter-min-price').value = '';
            document.getElementById('filter-max-price').value = '';
            if (window.firebaseApp && window.firebaseApp.applyFilters) {
                window.firebaseApp.applyFilters();
            }
        }

        function closeContactModal() {
            document.getElementById('contact-modal').classList.add('hidden');
        }

        function copyPhone() {
            const phoneInput = document.getElementById('contact-seller-phone');
            phoneInput.select();
            navigator.clipboard.writeText(phoneInput.value).then(() => {
                alert('‚úÖ Telefone copiado!');
            }).catch(() => {
                document.execCommand('copy');
                alert('‚úÖ Telefone copiado!');
            });
        }

        function openWhatsApp() {
            if (!currentWhatsAppNumber) {
                alert('N√∫mero de WhatsApp n√£o dispon√≠vel');
                return;
            }
            
            const message = `Ol√°! Tenho interesse no im√≥vel: ${currentPropertyName}`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/55${currentWhatsAppNumber}?text=${encodedMessage}`;
            
            window.open(whatsappURL, '_blank');
        }

        function applyFilters() {
            if (window.firebaseApp && window.firebaseApp.applyFilters) {
                window.firebaseApp.applyFilters();
            }
        }

        function handleLogout() {
            if (window.firebaseApp && window.firebaseApp.handleLogout) {
                window.firebaseApp.handleLogout();
            }
        }

        function showContactModal(propertyId) {
            if (window.firebaseApp && window.firebaseApp.showContactModal) {
                window.firebaseApp.showContactModal(propertyId);
            }
        }
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, query, orderBy, onSnapshot, Timestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB49M5r9YxXAKsMUR6aolTA09YIGBawPds",
            authDomain: "imobiliaria-2dd6e.firebaseapp.com",
            projectId: "imobiliaria-2dd6e",
            storageBucket: "imobiliaria-2dd6e.firebasestorage.app",
            messagingSenderId: "907112189443",
            appId: "1:907112189443:web:3030f06cae4e0cbc0d4836"
        };

        debugLog("üî• Inicializando Firebase...");
        
        // CR√çTICO MOBILE: Limpar qualquer flag travada de sess√µes anteriores
        sessionStorage.removeItem('auth_processing');
        debugLog("üßπ SessionStorage limpo");
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        debugLog("‚úÖ Firebase OK!");

        let currentUser = null;
        let allProperties = [];
        let unsubscribe = null;

        // Expor fun√ß√µes globalmente
        window.firebaseApp = {
            currentUser: null,
            
            applyFilters: function() {
                const search = document.getElementById('search-input').value.toLowerCase();
                const type = document.getElementById('filter-type').value;
                const neighborhood = document.getElementById('filter-neighborhood').value.toLowerCase();
                const minPrice = parseFloat(document.getElementById('filter-min-price').value) || 0;
                const maxPrice = parseFloat(document.getElementById('filter-max-price').value) || Infinity;
                
                let filtered = allProperties.filter(p => {
                    if (search && !p.name.toLowerCase().includes(search)) return false;
                    if (type && p.type !== type) return false;
                    if (neighborhood && !p.neighborhood.toLowerCase().includes(neighborhood)) return false;
                    if (p.price < minPrice || p.price > maxPrice) return false;
                    return true;
                });

                if (currentUser && currentUser.type === 'buyer' && currentUser.profile) {
                    const profile = currentUser.profile;
                    
                    filtered = filtered.filter(p => {
                        if (profile.propertyTypes && profile.propertyTypes.length > 0 && !profile.propertyTypes.includes(p.type)) {
                            return false;
                        }
                        if (profile.minPrice && p.price < profile.minPrice) return false;
                        if (profile.maxPrice && p.price > profile.maxPrice) return false;
                        if (profile.minRooms && p.rooms < profile.minRooms) return false;
                        if (profile.minParking && p.parking < profile.minParking) return false;
                        if (profile.minSize && p.size < profile.minSize) return false;
                        if (profile.maxSize && p.size > profile.maxSize) return false;
                        return true;
                    });
                }
                
                renderProperties(filtered);
            },

            handleLogout: async function() {
                if (confirm('Deseja sair?')) {
                    try {
                        if (unsubscribe) {
                            unsubscribe();
                            unsubscribe = null;
                        }
                        await signOut(auth);
                        location.reload();
                    } catch (error) {
                        console.error('‚ùå Erro:', error);
                        alert('Erro ao sair');
                    }
                }
            },

            showContactModal: function(propertyId) {
                const property = allProperties.find(p => p.id === propertyId);
                if (!property) return;
                
                document.getElementById('contact-property-name').textContent = property.name;
                document.getElementById('contact-property-builder').textContent = property.builder;
                document.getElementById('contact-property-address').textContent = `${property.street}, ${property.neighborhood}`;
                document.getElementById('contact-property-price').textContent = `R$ ${property.price.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('contact-seller-name').textContent = property.sellerName;
                document.getElementById('contact-seller-creci').textContent = property.sellerCreci;
                document.getElementById('contact-seller-phone').value = formatPhone(property.sellerPhone);
                
                // Armazenar dados para WhatsApp
                currentWhatsAppNumber = property.sellerPhone;
                currentPropertyName = property.name;
                
                document.getElementById('contact-modal').classList.remove('hidden');
            },

            showBuyerProfileScreen: function(isEdit = false) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('buyer-profile-screen').classList.remove('hidden');

                if (isEdit && currentUser && currentUser.profile) {
                    const profile = currentUser.profile;
                    
                    if (profile.minPrice) document.getElementById('profile-min-price').value = profile.minPrice;
                    if (profile.maxPrice) document.getElementById('profile-max-price').value = profile.maxPrice;
                    if (profile.neighborhoods) document.getElementById('profile-neighborhoods').value = profile.neighborhoods.join(', ');
                    if (profile.minRooms) document.getElementById('profile-min-rooms').value = profile.minRooms;
                    if (profile.minParking) document.getElementById('profile-min-parking').value = profile.minParking;
                    if (profile.minSize) document.getElementById('profile-min-size').value = profile.minSize;
                    if (profile.maxSize) document.getElementById('profile-max-size').value = profile.maxSize;
                    if (profile.notes) document.getElementById('profile-notes').value = profile.notes;

                    if (profile.propertyTypes) {
                        selectedPreferences.propertyTypes = [...profile.propertyTypes];
                        document.querySelectorAll('.preference-tag').forEach(tag => {
                            const text = tag.textContent;
                            if (profile.propertyTypes.includes(text)) {
                                tag.classList.add('selected');
                            }
                        });
                    }
                }
            },

            showMainApp: function(user) {
                debugLog(`üì± Iniciando showMainApp para: ${user.name}`);
                currentUser = user;
                window.firebaseApp.currentUser = user;
                
                debugLog('üîÑ Escondendo auth-screen...');
                document.getElementById('auth-screen').classList.add('hidden');
                
                debugLog('üîÑ Escondendo buyer-profile-screen...');
                document.getElementById('buyer-profile-screen').classList.add('hidden');
                
                debugLog('üîÑ Mostrando main-app...');
                document.getElementById('main-app').classList.remove('hidden');
                
                debugLog('‚úÖ Telas ajustadas!');
                
                document.getElementById('user-name-header').textContent = user.name;
                
                if (user.type === 'seller') {
                    debugLog('üëî Configurando para vendedor...');
                    document.getElementById('user-type-badge').textContent = `CRECI: ${user.creci}`;
                    document.getElementById('seller-controls').classList.remove('hidden');
                    document.getElementById('buyer-edit-profile-btn').classList.add('hidden');
                    document.getElementById('buyer-profile-summary').classList.add('hidden');
                } else {
                    debugLog('üõí Configurando para comprador...');
                    document.getElementById('user-type-badge').textContent = 'Comprador';
                    document.getElementById('seller-controls').classList.add('hidden');
                    document.getElementById('buyer-edit-profile-btn').classList.remove('hidden');
                    
                    if (user.profile) {
                        displayProfileSummary(user.profile);
                    }
                }
                
                debugLog('üì¶ Carregando propriedades...');
                loadProperties();
                debugLog('‚úÖ showMainApp completo!');
            }
        };

        // Auth State Observer COM PROTE√á√ÉO
        onAuthStateChanged(auth, async (user) => {
            debugLog('üîî onAuthStateChanged disparado');
            
            // PROTE√á√ÉO CONTRA LOOP: Verifica se j√° est√° processando nesta sess√£o
            if (sessionStorage.getItem('auth_processing') === 'true') {
                debugLog('‚è≠Ô∏è Ignorando (j√° est√° processando nesta sess√£o)');
                return;
            }

            debugLog(`üîê Estado Auth: ${user ? user.email : 'deslogado'}`);
            
            if (user) {
                debugLog('üë§ Usu√°rio autenticado - iniciando carregamento de dados');
                // Marcar que est√° processando
                sessionStorage.setItem('auth_processing', 'true');
                
                try {
                    debugLog(`üìÑ Buscando documento do usu√°rio ${user.uid}...`);
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        debugLog('‚úÖ Documento encontrado no Firestore!');
                        const userData = { id: user.uid, email: user.email, ...userDoc.data() };
                        currentUser = userData;
                        window.firebaseApp.currentUser = userData;
                        
                        debugLog(`üì± Tipo de usu√°rio: ${userData.type}`);
                        
                        // Limpar flag ANTES de mostrar app
                        sessionStorage.removeItem('auth_processing');
                        
                        if (userData.type === 'buyer' && !userData.profile) {
                            debugLog('üë§ Comprador sem perfil - mostrando tela de perfil');
                            window.firebaseApp.showBuyerProfileScreen();
                        } else {
                            debugLog('üè† Mostrando aplica√ß√£o principal');
                            window.firebaseApp.showMainApp(userData);
                        }
                    } else {
                        debugLog('‚ö†Ô∏è Documento n√£o existe no Firestore');
                        sessionStorage.removeItem('auth_processing');
                        currentRecoveryUser = user;
                        document.getElementById('recovery-modal').classList.remove('hidden');
                        document.getElementById('recovery-name').value = user.email.split('@')[0];
                    }
                } catch (error) {
                    console.error('‚ùå Erro:', error);
                    sessionStorage.removeItem('auth_processing');
                    alert('Erro ao carregar. Tente novamente.');
                    await signOut(auth);
                }
            } else {
                sessionStorage.removeItem('auth_processing');
                currentUser = null;
                window.firebaseApp.currentUser = null;
                if (unsubscribe) {
                    unsubscribe();
                    unsubscribe = null;
                }
            }
        });

        // Recovery Form Handler
        document.getElementById('recovery-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentRecoveryUser) {
                alert('Erro: Usu√°rio n√£o identificado');
                return;
            }

            const btn = document.getElementById('recovery-btn');
            const btnText = document.getElementById('recovery-btn-text');
            
            btn.disabled = true;
            btnText.textContent = 'Salvando...';
            
            try {
                const name = document.getElementById('recovery-name').value.trim();
                const userType = document.querySelector('input[name="recovery-type"]:checked').value;
                
                const userData = {
                    name,
                    email: currentRecoveryUser.email,
                    type: userType,
                    createdAt: new Date().toISOString()
                };
                
                if (userType === 'seller') {
                    const phone = document.getElementById('recovery-phone').value.trim().replace(/\D/g, '');
                    const creci = document.getElementById('recovery-creci').value.trim();
                    
                    if (!phone || !creci) {
                        throw new Error('Preencha telefone e CRECI');
                    }
                    
                    userData.phone = phone;
                    userData.creci = creci;
                }
                
                console.log('üíæ Salvando recupera√ß√£o...');
                await setDoc(doc(db, 'users', currentRecoveryUser.uid), userData);
                
                console.log('‚úÖ Salvo!');
                document.getElementById('recovery-modal').classList.add('hidden');
                currentRecoveryUser = null;
                
                // For√ßar recarga
                const user = auth.currentUser;
                if (user) {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const fullUserData = { id: user.uid, email: user.email, ...userDoc.data() };
                        currentUser = fullUserData;
                        window.firebaseApp.currentUser = fullUserData;
                        
                        if (fullUserData.type === 'buyer') {
                            window.firebaseApp.showBuyerProfileScreen();
                        } else {
                            window.firebaseApp.showMainApp(fullUserData);
                        }
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('Erro: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Salvar e Continuar';
            }
        });

        // Login Form
        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const btnText = document.getElementById('login-btn-text');
            const btnLoader = document.getElementById('login-btn-loader');
            
            // Verificar conectividade b√°sica
            if (!navigator.onLine) {
                debugLog('‚ùå SEM INTERNET');
                alert('‚ùå Voc√™ est√° offline. Conecte-se √† internet e tente novamente.');
                return;
            }
            
            debugLog('üì∂ Conex√£o detectada');
            
            // Testar conectividade com Firebase
            debugLog('üîç Testando conex√£o com Firebase...');
            try {
                const testResponse = await fetch('https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg', {
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                if (!testResponse.ok) {
                    throw new Error('Firebase inacess√≠vel');
                }
                debugLog('‚úÖ Firebase acess√≠vel');
            } catch (error) {
                debugLog('‚ùå Firebase bloqueado ou inacess√≠vel');
                alert('‚ùå N√£o consegui conectar ao Firebase.\n\nPoss√≠veis causas:\n- VPN bloqueando\n- Firewall corporativo\n- DNS bloqueado\n\nTente:\n- Desativar VPN\n- Usar dados m√≥veis\n- Trocar de rede');
                return;
            }
            
            btn.disabled = true;
            btnText.textContent = 'Autenticando...';
            btnLoader.classList.remove('hidden');
            
            // TIMEOUT DE SEGURAN√áA: Se demorar mais de 8 segundos, reabilitar bot√£o
            const safetyTimeout = setTimeout(() => {
                debugLog('‚ö†Ô∏è Login demorou muito - mostrando bot√£o de emerg√™ncia');
                btn.disabled = false;
                btnText.textContent = 'Entrar';
                btnLoader.classList.add('hidden');
                
                // Mostrar bot√£o de emerg√™ncia
                document.getElementById('emergency-reset').classList.remove('hidden');
                
                alert('‚ö†Ô∏è Login muito lento. Poss√≠veis causas:\n\n1. Conex√£o lenta\n2. Firewall bloqueando\n3. VPN ativo\n\nTente:\n- Desativar VPN\n- Trocar de rede WiFi\n- Usar dados m√≥veis');
            }, 8000);
            
            try {
                debugLog('üîê Tentando login...');
                debugLog('üì° Email: ' + email);
                
                // Tentar com timeout adicional
                const loginPromise = signInWithEmailAndPassword(auth, email, password);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('TIMEOUT')), 7000)
                );
                
                await Promise.race([loginPromise, timeoutPromise]);
                
                debugLog('‚úÖ Firebase Auth OK - aguardando onAuthStateChanged...');
                clearTimeout(safetyTimeout);
                
            } catch (error) {
                clearTimeout(safetyTimeout);
                debugLog('‚ùå Erro no login: ' + error.message);
                
                let errorMsg = 'Erro ao fazer login';
                
                if (error.message === 'TIMEOUT') {
                    errorMsg = 'Timeout: Conex√£o muito lenta. Tente:\n- Dados m√≥veis\n- Outra rede WiFi\n- Desativar VPN';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMsg = 'Sem conex√£o com internet';
                } else if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    errorMsg = 'Email ou senha incorretos';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMsg = 'Muitas tentativas. Aguarde 5 minutos';
                }
                alert('‚ùå ' + errorMsg);
                btn.disabled = false;
                btnText.textContent = 'Acessar Sistema';
                btnLoader.classList.add('hidden');
            }
        });

        // Register Form
        document.getElementById('form-register').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const userType = document.querySelector('input[name="user-type"]:checked').value;
            
            if (password !== confirmPassword) {
                alert('‚ùå Senhas n√£o coincidem');
                return;
            }
            
            const btn = document.getElementById('register-btn');
            const btnText = document.getElementById('register-btn-text');
            const btnLoader = document.getElementById('register-btn-loader');
            
            btn.disabled = true;
            btnText.textContent = 'Criando...';
            btnLoader.classList.remove('hidden');
            
            try {
                const userData = {
                    name,
                    email,
                    type: userType,
                    createdAt: new Date().toISOString()
                };
                
                if (userType === 'seller') {
                    const phone = document.getElementById('register-phone').value.trim();
                    const creci = document.getElementById('register-creci').value.trim();
                    const photo = document.getElementById('register-photo').value.trim();
                    const region = document.getElementById('register-region').value.trim();
                    const bio = document.getElementById('register-bio').value.trim();
                    
                    if (!phone || !creci) {
                        throw new Error('Preencha telefone e CRECI');
                    }
                    
                    userData.phone = phone.replace(/\D/g, '');
                    userData.creci = creci;
                    userData.profilePhoto = photo || null;
                    userData.region = region || null;
                    userData.bio = bio || null;
                    userData.verified = false;
                    userData.rating = 0;
                    userData.totalRatings = 0;
                }
                
                console.log('üìù Criando...');
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                console.log('üíæ Salvando...');
                await setDoc(doc(db, 'users', userCredential.user.uid), userData);
                
                console.log('‚úÖ Criado!');
                alert('‚úÖ Conta criada!');
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                let errorMsg = error.message;
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg = 'Email j√° cadastrado';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = 'Senha muito fraca (m√≠n 6 caracteres)';
                }
                alert('‚ùå ' + errorMsg);
                btn.disabled = false;
                btnText.textContent = 'Criar Conta';
                btnLoader.classList.add('hidden');
            }
        });

        // Buyer Profile Form
        document.getElementById('form-buyer-profile').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('profile-save-btn');
            const btnText = document.getElementById('profile-save-text');
            const btnLoader = document.getElementById('profile-save-loader');
            
            btn.disabled = true;
            btnText.textContent = 'Salvando...';
            btnLoader.classList.remove('hidden');
            
            try {
                const profileData = {
                    propertyTypes: selectedPreferences.propertyTypes || [],
                    minPrice: parseFloat(document.getElementById('profile-min-price').value) || null,
                    maxPrice: parseFloat(document.getElementById('profile-max-price').value) || null,
                    neighborhoods: document.getElementById('profile-neighborhoods').value
                        .split(',')
                        .map(n => n.trim())
                        .filter(n => n.length > 0),
                    minRooms: parseInt(document.getElementById('profile-min-rooms').value) || null,
                    minParking: parseInt(document.getElementById('profile-min-parking').value) || null,
                    minSize: parseFloat(document.getElementById('profile-min-size').value) || null,
                    maxSize: parseFloat(document.getElementById('profile-max-size').value) || null,
                    notes: document.getElementById('profile-notes').value.trim()
                };
                
                await updateDoc(doc(db, 'users', currentUser.id), {
                    profile: profileData
                });
                
                currentUser.profile = profileData;
                window.firebaseApp.currentUser.profile = profileData;
                
                console.log('‚úÖ Perfil salvo!');
                window.firebaseApp.showMainApp(currentUser);
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('‚ùå Erro: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Salvar e Continuar';
                btnLoader.classList.add('hidden');
            }
        });

        // Property Form
        document.getElementById('form-property').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const propertyType = document.getElementById('property-type').value;
            if (!propertyType) {
                alert('‚ùå Selecione o tipo');
                return;
            }

            const btn = document.getElementById('save-property-btn');
            const btnText = document.getElementById('save-btn-text');
            const btnLoader = document.getElementById('save-btn-loader');
            
            btn.disabled = true;
            btnText.textContent = 'Salvando...';
            btnLoader.classList.remove('hidden');
            
            try {
                const photos = [];
                for (let i = 1; i <= 5; i++) {
                    const photoUrl = document.getElementById(`property-photo-${i}`).value.trim();
                    if (photoUrl) {
                        photos.push(photoUrl);
                    }
                }
                
                if (photos.length === 0) {
                    throw new Error('Adicione pelo menos 1 foto do im√≥vel');
                }
                
                const propertyData = {
                    name: document.getElementById('property-name').value.trim(),
                    builder: document.getElementById('property-builder').value.trim(),
                    street: document.getElementById('property-street').value.trim(),
                    neighborhood: document.getElementById('property-neighborhood').value.trim(),
                    type: propertyType,
                    size: parseFloat(document.getElementById('property-size').value),
                    rooms: parseInt(document.getElementById('property-rooms').value),
                    parking: parseInt(document.getElementById('property-parking').value),
                    price: parseFloat(document.getElementById('property-price').value),
                    photos: photos,
                    description: document.getElementById('property-description').value.trim(),
                    sellerId: currentUser.id,
                    sellerName: currentUser.name,
                    sellerPhone: currentUser.phone,
                    sellerCreci: currentUser.creci,
                    createdAt: Timestamp.now()
                };
                
                await addDoc(collection(db, 'properties'), propertyData);
                
                console.log('‚úÖ Im√≥vel salvo!');
                alert('‚úÖ Cadastrado!');
                closePropertyModal();
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('‚ùå Erro: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Cadastrar';
                btnLoader.classList.add('hidden');
            }
        });

        // Load Properties
        function loadProperties() {
            const loadingState = document.getElementById('loading-state');
            const grid = document.getElementById('properties-grid');
            const emptyState = document.getElementById('empty-state');
            
            loadingState.classList.remove('hidden');
            grid.classList.add('hidden');
            emptyState.classList.add('hidden');
            
            try {
                if (unsubscribe) unsubscribe();
                
                const q = query(collection(db, 'properties'), orderBy('createdAt', 'desc'));
                
                unsubscribe = onSnapshot(q, 
                    (snapshot) => {
                        console.log(`üì¶ ${snapshot.size} im√≥veis`);
                        allProperties = [];
                        snapshot.forEach((docSnap) => {
                            allProperties.push({ id: docSnap.id, ...docSnap.data() });
                        });
                        window.firebaseApp.applyFilters();
                    },
                    (error) => {
                        console.error('‚ùå Erro:', error);
                        loadingState.classList.add('hidden');
                        emptyState.classList.remove('hidden');
                    }
                );
            } catch (error) {
                console.error('‚ùå Erro:', error);
                loadingState.classList.add('hidden');
                emptyState.classList.add('hidden');
            }
        }

        // Render Properties
        function renderProperties(properties) {
            const loadingState = document.getElementById('loading-state');
            const grid = document.getElementById('properties-grid');
            const emptyState = document.getElementById('empty-state');
            const resultsCount = document.getElementById('results-count');
            
            loadingState.classList.add('hidden');
            resultsCount.textContent = `${properties.length} ${properties.length === 1 ? 'im√≥vel' : 'im√≥veis'}`;
            
            if (properties.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            grid.innerHTML = properties.map(p => `
                <div class="card rounded-lg overflow-hidden">
                    ${p.photos && p.photos.length > 0 ? `
                        <div class="photo-gallery" data-property-id="${p.id}">
                            ${p.photos.map((photo, index) => `
                                <img src="${photo}" 
                                     alt="${p.name} - Foto ${index + 1}" 
                                     class="gallery-image ${index === 0 ? 'active' : ''}"
                                     onclick="openLightbox('${p.id}', ${index})"
                                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 300%22><rect fill=%22%23f3f4f6%22 width=%22400%22 height=%22300%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2220%22>Imagem indispon√≠vel</text></svg>'">
                            `).join('')}
                            
                            ${p.photos.length > 1 ? `
                                <button class="gallery-nav gallery-nav-prev" onclick="prevPhoto('${p.id}', ${p.photos.length})">‚ùÆ</button>
                                <button class="gallery-nav gallery-nav-next" onclick="nextPhoto('${p.id}', ${p.photos.length})">‚ùØ</button>
                                <div class="gallery-counter">1/${p.photos.length}</div>
                            ` : ''}
                        </div>
                        
                        ${p.photos.length > 1 ? `
                            <div class="gallery-thumbnails">
                                ${p.photos.map((photo, index) => `
                                    <img src="${photo}" 
                                         class="gallery-thumb ${index === 0 ? 'active' : ''}"
                                         onclick="showPhoto('${p.id}', ${index})"
                                         onerror="this.style.display='none'">
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div id="lightbox-${p.id}" class="lightbox" onclick="closeLightbox('${p.id}')">
                            ${p.photos.map((photo, index) => `
                                <img src="${photo}" 
                                     class="lightbox-image gallery-image ${index === 0 ? 'active' : ''}"
                                     onclick="event.stopPropagation()">
                            `).join('')}
                            <button class="lightbox-close" onclick="event.stopPropagation(); closeLightbox('${p.id}')">‚úï</button>
                            ${p.photos.length > 1 ? `
                                <button class="gallery-nav gallery-nav-prev" onclick="event.stopPropagation(); prevPhoto('${p.id}', ${p.photos.length})">‚ùÆ</button>
                                <button class="gallery-nav gallery-nav-next" onclick="event.stopPropagation(); nextPhoto('${p.id}', ${p.photos.length})">‚ùØ</button>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="h-56 relative overflow-hidden" style="background: var(--bg-light);">
                            <div class="w-full h-full flex items-center justify-center">
                                <svg class="w-16 h-16" style="color: var(--border-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                                </svg>
                            </div>
                        </div>
                    `}
                    
                    <div class="property-type-badge">
                        <span class="property-badge">${p.type}</span>
                    </div>
                    
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-2 line-clamp-2" style="color: var(--text-primary);">${p.name}</h3>
                        
                        <p class="text-sm mb-3" style="color: var(--text-secondary);">
                            üìç ${p.neighborhood}
                        </p>
                        
                        <div class="flex items-center gap-4 mb-4 text-sm" style="color: var(--text-secondary);">
                            <span>${p.size}m¬≤</span>
                            <span>${p.rooms} dorm</span>
                            <span>${p.parking} vaga${p.parking !== 1 ? 's' : ''}</span>
                        </div>
                        
                        <div class="divider mb-4"></div>
                        
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-xs mb-1" style="color: var(--text-secondary);">Valor</p>
                                <p class="text-2xl font-bold premium-accent">R$ ${p.price.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>
                        
                        <button onclick="showContactModal('${p.id}')" class="btn-accent w-full py-3 rounded-md font-semibold text-sm">
                            Contato
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Display Profile Summary
        function displayProfileSummary(profile) {
            const summary = document.getElementById('buyer-profile-summary');
            const content = document.getElementById('profile-summary-content');
            
            let tags = [];
            
            if (profile.propertyTypes && profile.propertyTypes.length > 0) {
                tags.push(...profile.propertyTypes.map(t => `<span class="preference-tag">${t}</span>`));
            }
            
            if (profile.minPrice || profile.maxPrice) {
                let priceText = '';
                if (profile.minPrice && profile.maxPrice) {
                    priceText = `R$ ${profile.minPrice.toLocaleString()} - R$ ${profile.maxPrice.toLocaleString()}`;
                } else if (profile.minPrice) {
                    priceText = `A partir de R$ ${profile.minPrice.toLocaleString()}`;
                } else {
                    priceText = `At√© R$ ${profile.maxPrice.toLocaleString()}`;
                }
                tags.push(`<span class="preference-tag">${priceText}</span>`);
            }
            
            if (profile.minRooms) {
                tags.push(`<span class="preference-tag">${profile.minRooms}+ quartos</span>`);
            }
            
            if (profile.minParking) {
                tags.push(`<span class="preference-tag">${profile.minParking}+ vagas</span>`);
            }
            
            if (tags.length > 0) {
                content.innerHTML = tags.join('');
                summary.classList.remove('hidden');
            }
        }
        
        // Contador de caracteres da biografia
        const bioTextarea = document.getElementById('register-bio');
        if (bioTextarea) {
            bioTextarea.addEventListener('input', function() {
                const counter = document.getElementById('bio-counter');
                if (counter) {
                    counter.textContent = this.value.length;
                }
            });
        }
        
        // Fun√ß√µes da Galeria de Fotos
        window.currentPhotoIndex = {};
        
        window.showPhoto = function(propertyId, index) {
            const gallery = document.querySelector(`[data-property-id="${propertyId}"]`);
            if (!gallery) return;
            
            const images = gallery.querySelectorAll('.gallery-image');
            const thumbs = gallery.querySelectorAll('.gallery-thumb');
            const counter = gallery.querySelector('.gallery-counter');
            
            images.forEach((img, i) => {
                img.classList.toggle('active', i === index);
            });
            
            thumbs.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
            
            if (counter) {
                counter.textContent = `${index + 1}/${images.length}`;
            }
            
            window.currentPhotoIndex[propertyId] = index;
        };
        
        window.nextPhoto = function(propertyId, totalPhotos) {
            const current = window.currentPhotoIndex[propertyId] || 0;
            const next = (current + 1) % totalPhotos;
            window.showPhoto(propertyId, next);
        };
        
        window.prevPhoto = function(propertyId, totalPhotos) {
            const current = window.currentPhotoIndex[propertyId] || 0;
            const prev = (current - 1 + totalPhotos) % totalPhotos;
            window.showPhoto(propertyId, prev);
        };
        
        window.openLightbox = function(propertyId, index) {
            const lightbox = document.getElementById(`lightbox-${propertyId}`);
            if (lightbox) {
                lightbox.classList.add('active');
                window.showPhoto(propertyId, index);
            }
        };
        
        window.closeLightbox = function(propertyId) {
            const lightbox = document.getElementById(`lightbox-${propertyId}`);
            if (lightbox) {
                lightbox.classList.remove('active');
            }
        };
    </script>
</body>
</html>
